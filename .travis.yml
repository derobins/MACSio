language: C

before_install:
  - sudo apt-get -qq update -y
  - sudo apt-get install -y gdb
  - sudo apt-get install -y mpich2
  - sudo apt-get install -y cmake
  - sudo apt-get install -y libhdf5-dev
  - which mpicc
  - which h5cc
  - dpkg -L libhdf5-dev
  - pwd
  - ls
  - pushd /tmp

  - wget https://github.com/LLNL/json-cwx/archive/0.12.tar.gz
  - tar -xzf 0.12.tar.gz
  - pushd json-cwx-0.12/json-cwx
  - sh autogen.sh
  - ./configure CC=mpicc --prefix=`pwd`/my_install
  - make -j4 install 1>/dev/null 2>&1
  - popd

  - wget https://portal.nersc.gov/project/visit/releases/3.0.0b/third_party/silo-4.10.2.tar.gz
  - tar -xzf silo-4.10.2.tar.gz
  - pushd silo-4.10.2
  - ./configure CC=mpicc --disable-hzip --disable-fpzip --disable-fortran --enable-install-lite-headers --prefix=`pwd`/my_install DEFAULT_HDF5_LIBDIR=/tmp DEFAULT_HDF5_INCLUDE=/tmp --with-hdf5=yes
  - make -j4 install 1>/dev/null 2>&1
  - popd

  - popd

install: true

before_script:
- ulimit -c unlimited -S

script:
  - mkdir build
  - pushd build
  - cmake -DCMAKE_BUILD_TYPE:STRING=Debug -DMPI_C_COMPILE_FLAGS:STRING="-g -O0 -fPIC --coverage" -DMPI_CXX_COMPILE_FLAGS:STRING="-g -O0 -fPIC --coverage" -DCMAKE_C_FLAGS:STRING="-g -O0 -fPIC --coverage" -DCMAKE_CXX_FLAGS:STRING="-g -O0 -fPIC --coverage" -DMPI_CXX_LINK_FLAGS:STRING="--coverage -lm" -DCMAKE_EXE_LINKER_FLAGS:STRING="--coverage -lm" -DCMAKE_C_COMPILER:PATH=`which mpicc` -DCMAKE_CXX_COMPILER:PATH=`which mpicxx` -DWITH_JSON-CWX_PREFIX=/tmp/json-cwx-0.12/json-cwx/my_install -DENABLE_HDF5_PLUGIN=ON -DENABLE_PDB_PLUGIN=ON -DENABLE_SILO_PLUGIN=ON -DWITH_SILO_PREFIX=/tmp/silo-4.10.2/my_install ../.
  - make VERBOSE=1
  - make check
  - pushd macsio; gcov `find . -name '*.gcno'`; popd;

after_failure:
  - COREFILE=$(find . -name "*core*" | head -n 1) # find core file
  - if [[ -f "$COREFILE" ]]; then gdb -c "$COREFILE" ./macsio/tstprng -ex "thread apply all bt" -ex "set pagination 0" -batch; fi

after_success:
  - bash <(curl -s https://codecov.io/bash)
